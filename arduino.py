import requests
import json
import random
import time
import math

# URL –≤–∞—à–µ–≥–æ Django-—Å–µ—Ä–≤–µ—Ä–∞
url = 'http://localhost:8000/esp/receive/'  # –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø—É—Ç—å —Å–æ–≥–ª–∞—Å–Ω–æ –≤–∞—à–µ–π view

# –ó–∞—Ä–∞–Ω–µ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª–µ—Ç–∞
# –§–æ—Ä–º–∞—Ç: (pwm_duty_cycle, rpm_percentage, –æ–∂–∏–¥–∞–µ–º–∞—è_–º–∏–Ω_–º–æ—â–Ω–æ—Å—Ç—å)
OPTIMAL_PARAMS = {
    1: (0.55, 55.0, 45.2),  # –ü–æ–ª–µ—Ç 1: –æ–ø—Ç–∏–º—É–º –ø—Ä–∏ –®–ò–ú=0.55, –æ–±–æ—Ä–æ—Ç—ã=55%
    2: (0.65, 45.0, 50.1),  # –ü–æ–ª–µ—Ç 2: –æ–ø—Ç–∏–º—É–º –ø—Ä–∏ –®–ò–ú=0.65, –æ–±–æ—Ä–æ—Ç—ã=45%
    3: (0.45, 65.0, 40.5)  # –ü–æ–ª–µ—Ç 3: –æ–ø—Ç–∏–º—É–º –ø—Ä–∏ –®–ò–ú=0.45, –æ–±–æ—Ä–æ—Ç—ã=65%
}

# –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –Ω–∞ –∫–∞–∂–¥—ã–π –ø–æ–ª—ë—Ç (–º–∏–Ω–∏–º—É–º 20 –¥–ª—è —Ö–æ—Ä–æ—à–µ–π —Ä–µ–≥—Ä–µ—Å—Å–∏–∏)
records_per_flight = 30

# –ü–∞—É–∑–∞ –º–µ–∂–¥—É –æ—Ç–ø—Ä–∞–≤–∫–∞–º–∏ (–≤ —Å–µ–∫—É–Ω–¥–∞—Ö)
delay_between_requests = 0.1  # –£–º–µ–Ω—å—à–µ–Ω–æ –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏


def generate_realistic_data(flight_id, record_num):
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å –∑–∞—Ä–∞–Ω–µ–µ –∏–∑–≤–µ—Å—Ç–Ω—ã–º –æ–ø—Ç–∏–º—É–º–æ–º"""
    # –ü–æ–ª—É—á–∞–µ–º –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª–µ—Ç–∞
    opt_pwm, opt_rpm, min_power = OPTIMAL_PARAMS[flight_id]

    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å —Ñ–æ–∫—É—Å–æ–º –Ω–∞ –æ–±–ª–∞—Å—Ç–∏ –≤–æ–∫—Ä—É–≥ –æ–ø—Ç–∏–º—É–º–∞
    if random.random() < 0.7:  # 70% –¥–∞–Ω–Ω—ã—Ö –≤–æ–∫—Ä—É–≥ –æ–ø—Ç–∏–º—É–º–∞
        # –¢–æ—á–∫–∏ –æ–∫–æ–ª–æ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
        pwm = opt_pwm + random.uniform(-0.15, 0.15)
        rpm = opt_rpm + random.uniform(-8.0, 8.0)
    else:  # 30% –¥–∞–Ω–Ω—ã—Ö –≤ –¥—Ä—É–≥–∏—Ö –æ–±–ª–∞—Å—Ç—è—Ö
        pwm = random.uniform(0.35, 0.85)
        rpm = random.uniform(30.0, 80.0)

    # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω—ã
    pwm = max(0.35, min(0.85, pwm))
    rpm = max(30.0, min(80.0, rpm))

    # –§–æ—Ä–º—É–ª–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —á–µ—Ç–∫–æ–≥–æ –º–∏–Ω–∏–º—É–º–∞ –º–æ—â–Ω–æ—Å—Ç–∏ –≤ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–π —Ç–æ—á–∫–µ
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–≤—É–º–µ—Ä–Ω—É—é –ø–∞—Ä–∞–±–æ–ª—É —Å –º–∏–Ω–∏–º—É–º–æ–º –≤ —Ç–æ—á–∫–µ (opt_pwm, opt_rpm)
    distance_pwm = (pwm - opt_pwm) ** 2
    distance_rpm = (rpm - opt_rpm) ** 2

    # –ë–∞–∑–æ–≤–∞—è –º–æ—â–Ω–æ—Å—Ç—å —Å —à—É–º–æ–º –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å—é –æ—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –¥–æ –æ–ø—Ç–∏–º—É–º–∞
    base_power = min_power + (distance_pwm * 150 + distance_rpm * 0.8) + random.uniform(-2.0, 3.0)

    # –†–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏—è –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è –∏ —Ç–æ–∫–∞
    voltage = random.uniform(11.2, 12.4)  # –†–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ–µ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ LiPo –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫–æ–π
    current = base_power / voltage

    # –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π —à—É–º –∏ –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏
    if random.random() < 0.15:  # 15% —Ç–æ—á–µ–∫ - –≤—ã–±—Ä–æ—Å—ã
        current *= random.uniform(1.3, 1.8)

    # –û–∫—Ä—É–≥–ª–µ–Ω–∏–µ –¥–æ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ–π —Ç–æ—á–Ω–æ—Å—Ç–∏
    return {
        "voltage": round(voltage, 2),
        "current": round(current, 2),
        "pwm_duty_cycle": round(pwm, 3),
        "rpm_percentage": round(rpm, 1),
        "flight_id": flight_id
    }


def print_optimal_summary():
    """–í—ã–≤–æ–¥–∏—Ç —Å–≤–æ–¥–∫—É –ø–æ –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏"""
    print("\n" + "=" * 60)
    print("–ó–ê–†–ê–ù–ï–ï –ò–ó–í–ï–°–¢–ù–´–ï –û–ü–¢–ò–ú–ê–õ–¨–ù–´–ï –ü–ê–†–ê–ú–ï–¢–†–´ –î–õ–Ø –ü–†–û–í–ï–†–ö–ò:")
    print("=" * 60)
    for flight_id, (opt_pwm, opt_rpm, min_power) in OPTIMAL_PARAMS.items():
        print(f"–ü–æ–ª–µ—Ç #{flight_id}:")
        print(f"  ‚Ä¢ –û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è —Å–∫–≤–∞–∂–Ω–æ—Å—Ç—å –®–ò–ú: {opt_pwm:.3f}")
        print(f"  ‚Ä¢ –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –æ–±–æ—Ä–æ—Ç—ã: {opt_rpm:.1f}%")
        print(f"  ‚Ä¢ –û–∂–∏–¥–∞–µ–º–∞—è –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –º–æ—â–Ω–æ—Å—Ç—å: {min_power:.1f} –í—Ç")
        print(f"  ‚Ä¢ –†–∞—Å—á–µ—Ç–Ω–æ–µ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ –ø—Ä–∏ –æ–ø—Ç–∏–º—É–º–µ: ~12.0 –í")
        print(f"  ‚Ä¢ –†–∞—Å—á–µ—Ç–Ω—ã–π —Ç–æ–∫ –ø—Ä–∏ –æ–ø—Ç–∏–º—É–º–µ: ~{min_power / 12.0:.1f} –ê")
        print("-" * 60)
    print("=" * 60)


# –í—ã–≤–æ–¥–∏–º —Å–≤–æ–¥–∫—É –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
print_optimal_summary()

# –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª–µ—Ç–∞
for flight_id in range(1, 4):  # –ü–æ–ª–µ—Ç—ã 1, 2, 3
    print(f"\nüöÄ –ù–ê–ß–ê–õ–û –û–¢–ü–†–ê–í–ö–ò –î–ê–ù–ù–´–• –î–õ–Ø –ü–û–õ–ï–¢–ê #{flight_id}")
    print("-" * 50)

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø–∏—Å–∏ –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª–µ—Ç–∞
    for i in range(records_per_flight):
        data = generate_realistic_data(flight_id, i)

        # –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–º–Ω–æ–≥–æ –¥–∏–Ω–∞–º–∏–∫–∏ –≤–æ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –ø–µ—Ä–≤–æ–π –∑–∞–ø–∏—Å–∏
        if i == 0:
            time.sleep(0.5)  # –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞ –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –ø–æ–ª–µ—Ç–∞

        json_data = json.dumps(data)
        headers = {'Content-Type': 'application/json'}

        try:
            response = requests.post(url, data=json_data, headers=headers)
            if response.status_code == 200:
                status = "‚úÖ" if (abs(data['pwm_duty_cycle'] - OPTIMAL_PARAMS[flight_id][0]) < 0.05 and
                                 abs(data['rpm_percentage'] - OPTIMAL_PARAMS[flight_id][1]) < 3.0) else "  "
                print(
                    f"[{status} Flight {flight_id}, #{i + 1:2d}] PWM: {data['pwm_duty_cycle']:.3f}, RPM: {data['rpm_percentage']:5.1f}%, "
                    f"Power: {data['voltage'] * data['current']:5.1f}W | {response.json()['status']}")
            else:
                print(f"[‚ùå Flight {flight_id}, #{i + 1}] ERROR {response.status_code}: {response.text}")

        except requests.exceptions.RequestException as e:
            print(f"[üî• Flight {flight_id}, #{i + 1}] REQUEST ERROR: {e}")

        time.sleep(delay_between_requests)

    print(f"\n‚úÖ –ü–û–õ–ï–¢ #{flight_id} –ó–ê–í–ï–†–®–ï–ù. –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ {records_per_flight} –∑–∞–ø–∏—Å–µ–π.")
    time.sleep(1)  # –ü–∞—É–∑–∞ –º–µ–∂–¥—É –ø–æ–ª–µ—Ç–∞–º–∏

print("\n" + "=" * 60)
print("üéâ –ì–ï–ù–ï–†–ê–¶–ò–Ø –î–ê–ù–ù–´–• –£–°–ü–ï–®–ù–û –ó–ê–í–ï–†–®–ï–ù–ê!")
print("=" * 60)
print("–¢–µ–ø–µ—Ä—å –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ –≤ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ.")
print("–û–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–æ–ª–∂–Ω—ã —Å–æ–≤–ø–∞—Å—Ç—å —Å –∑–∞—Ä–∞–Ω–µ–µ –∏–∑–≤–µ—Å—Ç–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏:")
for flight_id, (opt_pwm, opt_rpm, min_power) in OPTIMAL_PARAMS.items():
    print(f"  ‚Ä¢ –ü–æ–ª–µ—Ç #{flight_id}: –®–ò–ú={opt_pwm:.3f}, –û–±–æ—Ä–æ—Ç—ã={opt_rpm:.1f}%")
print("=" * 60)